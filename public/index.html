<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bus Realtime</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    .label {
      background: #0b5; color: #fff; padding: 2px 6px; border-radius: 12px;
      font: 12px/18px system-ui, Arial, sans-serif; white-space: nowrap;
      border: 1px solid rgba(0,0,0,0.15); box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    }
    .toast {
      position: absolute; top: 8px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.7); color: #fff; padding: 6px 10px; border-radius: 6px; font: 12px system-ui;
      z-index: 2; display: none;
    }
    .toast.show { display: inline-block; }
  </style>
  <!-- Google Maps JS API: uses your billed API key -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyByVXu-kDUu9iYS3HJ9UE4fmLmAn485mY0&v=weekly"></script>
</head>
<body>
  <div class="toast" id="toast">Connectingâ€¦</div>
  <div id="map"></div>

  <script>
    let map, AdvancedMarkerElement;
    const markers = {}; // bus_id -> AdvancedMarkerElement
    const toast = document.getElementById("toast");

    function showToast(msg, ms=2000) {
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), ms);
    }

    async function initMap() {
      // Wait until Maps is loaded
      while (!(window.google && google.maps)) {
        await new Promise(r => setTimeout(r, 50));
      }

      // Create map with your Map ID (required for Advanced Markers)
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 28.6139, lng: 77.2090 },
        zoom: 12,
        mapId: "ee14e5612cce433e785797ee",
        disableDefaultUI: false,
      });

      // Load Advanced Marker library
      const lib = await google.maps.importLibrary("marker");
      AdvancedMarkerElement = lib.AdvancedMarkerElement;

      // Connect to viewer WebSocket
      const wsUrl = "wss://bus-realtime.onrender.com/map";
      const ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        showToast("Connected to live map", 1500);
        console.log("WS open:", wsUrl);
      };

      ws.onmessage = (ev) => {
        try {
          const d = JSON.parse(ev.data);
          const id = String(d.bus_id ?? "");
          const lat = Number(d.lat);
          const lng = Number(d.lng);
          if (!id || !Number.isFinite(lat) || !Number.isFinite(lng)) return;

          const pos = { lat, lng };

          // First time: create advanced marker with a simple label
          if (!markers[id]) {
            const content = document.createElement("div");
            content.className = "label";
            content.textContent = `Bus ${id}`;
            markers[id] = new AdvancedMarkerElement({
              map,
              position: pos,
              title: `Bus ${id}`,
              content,
            });
          } else {
            // Update position
            markers[id].position = pos;
          }
        } catch (e) {
          console.error("Bad WS payload", e);
        }
      };

      ws.onerror = (e) => {
        console.error("WS error", e);
        showToast("WebSocket error");
      };
      ws.onclose = () => {
        console.warn("WS closed");
        showToast("Disconnected");
      };
    }

    // Boot
    initMap();
  </script>
</body>
</html>