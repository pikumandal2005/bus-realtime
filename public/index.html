<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Live Bus Map</title>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    #status { position: absolute; top: 8px; left: 8px; background: #fff; padding: 6px 10px; border-radius: 6px; font-family: Arial, sans-serif; box-shadow: 0 1px 4px rgba(0,0,0,.2); z-index: 2; }
  </style>
</head>
<body>
  <div id="status">Connecting…</div>
  <div id="map"></div>

  <script>
    let map;
    const markers = new Map();
    function setStatus(t) { document.getElementById('status').textContent = t; }

    async function initMap() {
      const { Map } = await google.maps.importLibrary("maps");
      const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
      const center = { lat: 28.6139, lng: 77.2090 }; // Delhi
      map = new Map(document.getElementById("map"), { zoom: 11, center });

      // IMPORTANT: When deployed on Render, set WSS to your service domain.
      const WS_URL = (location.hostname.endsWith("onrender.com"))
        ? `wss://${location.host}/map`
        : "ws://localhost:8080/map"; // local dev fallback

      const ws = new WebSocket(WS_URL);
      ws.onopen = () => setStatus("Live: connected");
      ws.onclose = () => setStatus("Disconnected. Reconnecting…");
      ws.onerror = () => setStatus("Error: reconnecting…");
      ws.onmessage = (ev) => {
        try {
          const d = JSON.parse(ev.data);
          const id = String(d.bus_id);
          const pos = { lat: Number(d.lat), lng: Number(d.lng) };
          let m = markers.get(id);
          if (!m) {
            m = new AdvancedMarkerElement({ map, position: pos, title: `Bus ${id}` });
            markers.set(id, m);
          } else {
            m.position = pos;
          }
        } catch {}
      };
    }
  </script>

  <!-- Load Google Maps JS API: insert your key -->
  <script>
    (g => {
      var h, a, k, p = "The Google Maps JavaScript API", c = "google", l = "importLibrary", q = "__ib__", m = document, b = window;
      b = b[c] || (b[c] = {}); var d = b.maps || (b.maps = {}), r = new Set, e = new URLSearchParams,
      u = () => h || (h = new Promise(async (f, n) => {
        await (a = m.createElement("script"));
        e.set("libraries", [...r] + "");
        for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t.toLowerCase()), g[k]);
        e.set("callback", c + ".maps." + q);
        a.src = `https://maps.${c}apis.com/maps/api/js?` + e;
        d[q] = f; a.onerror = () => h = n(Error(p + " could not load."));
        a.nonce = m.querySelector("script[nonce]")?.nonce || "";
        m.head.append(a);
      }));
      d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n))
    })({ key: "AIzaSyByVXu-kDUu9iYS3HJ9UE4fmLmAn485mY0", v: "weekly" });
  </script>
  <script>initMap()</script>
</body>
</html>